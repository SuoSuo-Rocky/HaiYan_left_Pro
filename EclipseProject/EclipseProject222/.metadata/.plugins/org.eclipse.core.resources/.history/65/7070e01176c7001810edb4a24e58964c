package com.example.name666666;
                                      //æºç çš?
import java.util.Timer;
import java.util.TimerTask;
import java.util.UUID;

import com.example.name666666.BluetoothLeClass.OnDataAvailableListener;
import com.example.name666666.BluetoothLeClass.OnServiceDiscoverListener;
import com.fro.util.FROSun;
import com.fro.util.HexStrConvertUtil;

import android.app.Activity;
import android.bluetooth.BluetoothAdapter;
import android.bluetooth.BluetoothDevice;
import android.bluetooth.BluetoothGatt;
import android.bluetooth.BluetoothGattCharacteristic;
import android.bluetooth.BluetoothGattService;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.CompoundButton;
import android.widget.CompoundButton.OnCheckedChangeListener;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.ToggleButton;

public class MainActivity extends Activity {
	public static String TAG = "MainActivity";

	private final Timer timer = new Timer();
	private TimerTask task;
	private Handler handler;

	private static final String UUID_SERVICE = "0000fff0-0000-1000-8000-00805f9b34fb";
	private static final String UUID_CHAR6 = "0000fff6-0000-1000-8000-00805f9b34fb";
	private static final String UUID_DESC = "00002902-0000-1000-8000-00805f9b34fb";

	private ToggleButton scan_tb;
	private ListView bleDev_lv;
	private TextView recv_tv;
	private TextView info_tv;

	// BLEè®¾å¤‡
	private BluetoothLeClass mBLE;

	// è“ç‰™GATTæœåŠ¡
	private BluetoothGattService mService;

	// è“ç‰™GATTæ•°æ®æè¿°ç¬?
	private BluetoothGattCharacteristic gattCharacteristic_char6;

	// è“ç‰™BLEåˆ—è¡¨é€‚é…å™?
	private LeDeviceListAdapter mLeDeviceListAdapter;

	// æ¥æ”¶çš„å­—æ®?
	private StringBuilder recv_sb;
	
	// æ˜¯å¦å¼?å¯è¯»å†™æ•°æ?
	private boolean isReadTaskRun;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_main);

		// ç»‘å®šæ§ä»¶
		bindView();

		// åˆå§‹åŒ–æ•°æ?
		initData();

		// åˆå§‹åŒ–äº‹ä»?
		initEvent();

		// åˆ›å»ºBLEå®ä¾‹
		mBLE = new BluetoothLeClass(this);
		// åˆå§‹åŒ–BLE
		if (mBLE.initialize()) {
			info_tv.setText("åˆå§‹åŒ–BLEæˆåŠŸ!");
			// Log.i(TAG, "åˆå§‹åŒ–BLEæˆåŠŸ");
		} else {
			info_tv.setText("åˆå§‹åŒ–BLEå¤±è´¥!");
			// Log.i(TAG, "åˆå§‹åŒ–BLEå¤±è´¥");
		}

		// å‘ç°BLEç»ˆç«¯çš„Serviceæ—¶å›è°?
		mBLE.setOnServiceDiscoverListener(mOnServiceDiscover);
		// æ”¶åˆ°BLEç»ˆç«¯æ•°æ®äº¤äº’çš„äº‹ä»?
		mBLE.setOnDataAvailableListener(mOnDataAvailable);
	}

	/**
	 * ç»‘å®šæ§ä»¶
	 */
	private void bindView() {
		scan_tb = (ToggleButton) findViewById(R.id.scan_tb);
		bleDev_lv = (ListView) findViewById(R.id.bleDev_lv);
		recv_tv = (TextView) findViewById(R.id.recv_tv);
		info_tv = (TextView) findViewById(R.id.info_tv);
	}

	/**
	 * åˆå§‹åŒ–æ•°æ?
	 */
	private void initData() {

		// æ¥æ”¶å­—æ®µ
		recv_sb = new StringBuilder("");
		// BLEåˆ—è¡¨
		mLeDeviceListAdapter = new LeDeviceListAdapter(this);
		bleDev_lv.setAdapter(mLeDeviceListAdapter);

	}

	/**
	 * åˆå§‹åŒ–äº‹ä»?
	 */
	private void initEvent() {

		// å¤„ç†æ¶ˆæ¯
		handler = new Handler() {
			@Override
			public void handleMessage(Message msg) {
				// TODO Auto-generated method stub
				// é—´éš”1ç§?,æ”¶åˆ°msgåˆ™è¯»å–ä¸€æ¬¡æ•°æ?
				if (msg.what == 1) {
					if (isReadTaskRun) {
						ReadBle();
					}
				}
			}
		};

		// å®šæ—¶ä»»åŠ¡
		task = new TimerTask() {
			@Override
			public void run() {
				Message message = new Message();
				message.what = 1;
				handler.sendMessage(message);
			}
		};
		
		// å¼?å¯è¯»å–æ•°æ®çº¿ç¨?
		timer.schedule(task, 100, 1000);

		// æ‰«æ
		scan_tb.setOnCheckedChangeListener(new OnCheckedChangeListener() {
			@Override
			public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
				if (isChecked) {
					// æ¸…ç©ºåˆ—è¡¨
					mLeDeviceListAdapter.clear();
					// å¼?å§‹æ‰«æ?
					mBLE.getmBluetoothAdapter().startLeScan(mLeScanCallback);
					info_tv.setText("æ­£åœ¨æ‰«æBLEç»ˆç«¯...");
				} else {
					// åœæ­¢æ‰«æ
					mBLE.getmBluetoothAdapter().stopLeScan(mLeScanCallback);
					info_tv.setText("å·²åœæ­¢æ‰«æBLEç»ˆç«¯");
				}
			}
		});

		// Itemç‚¹å‡»
		bleDev_lv.setOnItemClickListener(new OnItemClickListener() {
			@Override
			public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
				// åœæ­¢æ‰«æ
				scan_tb.setChecked(false);
				mBLE.getmBluetoothAdapter().stopLeScan(mLeScanCallback);
				// è·å¾—device
				final BluetoothDevice device = mLeDeviceListAdapter.getDevice(position);
				if (device == null)
					return;
				// ç‚¹å‡»åˆ‡æ¢å¼?å¯ä»»åŠ?
				isReadTaskRun = !isReadTaskRun;
				if (isReadTaskRun) {
					// å»ºç«‹GATTè¿æ¥
					info_tv.setText("æ­£åœ¨è¿æ¥BLEç»ˆç«¯...");
					if (!mBLE.connect(device.getAddress())) {
						info_tv.setText("è¿æ¥å¤±è´¥ï¼?");
					}
				} else {
					mBLE.disconnect();
					info_tv.setText("æ–­å¼€è¿æ¥ï¼?");
				}
			}
		});
	}

	/**
	 * æœç´¢åˆ°è®¾å¤‡Deviceçš„å›è°ƒäº‹ä»?
	 */
	private BluetoothAdapter.LeScanCallback mLeScanCallback = new BluetoothAdapter.LeScanCallback() {

		@Override
		public void onLeScan(final BluetoothDevice device, int rssi, byte[] scanRecord) {
			runOnUiThread(new Runnable() {
				@Override
				public void run() {
					mLeDeviceListAdapter.addDevice(device);
					mLeDeviceListAdapter.notifyDataSetChanged();
				}
			});
		}
	};

	/**
	 * æœç´¢åˆ°BLEç»ˆç«¯æœåŠ¡çš„ç›‘å¬äº‹ä»?
	 */
	private BluetoothLeClass.OnServiceDiscoverListener mOnServiceDiscover = new OnServiceDiscoverListener() {

		@Override
		public void onServiceDiscover(BluetoothGatt gatt) {
			// å¯»æ‰¾åˆ°æœåŠ?
			// å¯»æ‰¾æœåŠ¡ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å’Œè®¾å¤‡è¿›è¡Œé?šä¿¡ï¼Œæ¯”å¦‚ä¸‹å‘é…ç½®å?¼ï¼Œè·å–è®¾å¤‡ç”µé‡ä»?ä¹ˆçš„

			// å¦‚ä¸Šé¢æ‰€è¯´ï¼Œæƒ³è¦å’Œä¸€ä¸ªå­¦ç”Ÿé?šä¿¡ï¼Œå…ˆçŸ¥é“ä»–çš„ç­çº§ï¼ˆServiceUUIDï¼‰å’Œå­¦å·ï¼ˆCharacUUIDï¼?
			mService = gatt.getService(UUID.fromString(UUID_SERVICE));
			if (mService != null) {
				// UUID_CHAR6æ˜¯å¯ä»¥è·Ÿè“ç‰™æ¨¡å—ä¸²å£é€šä¿¡çš„Characteristic
				gattCharacteristic_char6 = mService.getCharacteristic(UUID.fromString(UUID_CHAR6));
				if (gattCharacteristic_char6 != null) {
					// è®¾ç½®è®¾å¤‡å¯é?šçŸ¥
					mBLE.setCharacteristicNotification(gattCharacteristic_char6, true);
					// æ›´æ–°æ¥æ”¶åŒºç•Œé¢æ˜¾ç¤?
					runOnUiThread(new Runnable() {
						@Override
						public void run() {
							info_tv.setText("è¿æ¥æˆåŠŸï¼?");
						}
					});

				} else {
					Log.i(TAG, "mCharacteristic = null");
				}
			} else {
				Log.i(TAG, "mService = null");
				runOnUiThread(new Runnable() {
					@Override
					public void run() {
						info_tv.setText("è®¾ç½®å¤±è´¥ï¼?");
					}
				});
			}
		}

	};

	/**
	 * æ”¶åˆ°BLEç»ˆç«¯æ•°æ®äº¤äº’çš„ç›‘å¬äº‹ä»?
	 */
	private BluetoothLeClass.OnDataAvailableListener mOnDataAvailable = new OnDataAvailableListener() {
		/**
		 * BLEç»ˆç«¯æ•°æ®è¢«è¯»çš„äº‹ä»?
		 */
		@Override
		public void onCharacteristicRead(BluetoothGatt gatt, BluetoothGattCharacteristic characteristic, int status) {
			// æ‰§è¡Œ mBLE.readCharacteristic(gattCharacteristic); åå°±ä¼šæ”¶åˆ°æ•°æ?
			// if(status == BluetoothGatt.GATT_SUCCESS)
			Log.i(TAG, "onCharRead " + gatt.getDevice().getName() + " read " + characteristic.getUuid().toString()
					+ " -> " + HexStrConvertUtil.bytesToHexString(characteristic.getValue()));

		}

		/**
		 * æ”¶åˆ°BLEç»ˆç«¯å†™å…¥æ•°æ®å›è°ƒ
		 */
		@Override
		public void onCharacteristicWrite(BluetoothGatt gatt, BluetoothGattCharacteristic characteristic) {
			// æ”¶åˆ°è®¾å¤‡notifyå€? ï¼ˆè®¾å¤‡ä¸ŠæŠ¥å?¼ï¼‰ï¼Œæ ¹æ? characteristic.getUUID()æ¥åˆ¤æ–­æ˜¯è°å‘é€å?¼ç»™ä½ ï¼Œ
			// æ ¹æ®characteristic.getValue()æ¥è·å–è¿™ä¸ªå??
			Log.i(TAG, "characteristic.getUuid().toString()=" + characteristic.getUuid().toString());
			if (characteristic.getUuid().toString().equals(UUID_CHAR6)) {

				// æ¥æ”¶æ•°æ®
				Float fData = FROSun.getData(Const.SUN_LEN, Const.NODE_NUM, characteristic.getValue());
				String value = String.valueOf((int) (float) fData + "Lux");

				Log.i(TAG, "onCharWrite=" + gatt.getDevice().getName() + "   value=" + value);

				// è¿½åŠ åˆ°æ¥æ”¶å­—æ®?
				recv_sb.replace(0, recv_sb.length(), value);
				// æ›´æ–°æ¥æ”¶åŒºç•Œé¢æ˜¾ç¤?
				runOnUiThread(new Runnable() {
					@Override
					public void run() {
						updateDisplaySendInfo();
					}
				});
			}
		}
	};

	/**
	 * æ›´æ–°æ˜¾ç¤ºæ¥æ”¶åŒ?
	 * 
	 * @param send
	 * @param recv
	 */
	public void updateDisplaySendInfo() {
		recv_tv.setText(recv_sb.toString());
	}

	@Override
	protected void onPause() {
		super.onPause();
	}

	@Override
	protected void onDestroy() {
		super.onDestroy();
		timer.cancel();
		mBLE.getmBluetoothAdapter().stopLeScan(mLeScanCallback);
		mBLE.disconnect();
		mBLE.close();
	}

	/**
	 * è¯»å–BLEæ•°æ®
	 */
	private void ReadBle() {
		// TODO Auto-generated method stub
		if (mBLE.getmBluetoothGatt() != null && gattCharacteristic_char6 != null) {
			// è·å–å‘é?å‘½ä»?
			String writeStr = Const.SUN_CMD;
			// è®¾ç½®æ•°æ®å†…å®¹
			gattCharacteristic_char6.setValue(HexStrConvertUtil.hexStringToByte(writeStr));
			// å¾?è“ç‰™æ¨¡å—å†™å…¥æ•°æ®
			mBLE.getmBluetoothGatt().writeCharacteristic(gattCharacteristic_char6);
			Log.i(TAG, "è¯»å–æ•°æ®...");
		} else {
			Log.i(TAG, "mBLE.getmBluetoothGatt()=null or gattCharacteristic_char6=null");
		}
	}

}